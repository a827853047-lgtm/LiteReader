<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LiteReader è½»é˜…</title>
    <meta name="description" content="æç®€æœ¬åœ°ç”µå­ä¹¦é˜…è¯»å™¨">
    <meta name="theme-color" content="#121212">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: { bg: '#000000', surface: '#1c1c1e', text: '#e5e5e7', sub: '#8e8e93' },
                        light: { bg: '#f2f2f7', surface: '#ffffff', text: '#000000', sub: '#8e8e93' },
                        brand: '#0a84ff'
                    },
                    padding: {
                        'safe': 'env(safe-area-inset-bottom)'
                    }
                }
            }
        }
    </script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://cdn.staticfile.net/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdn.staticfile.net/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://cdn.staticfile.net/babel-standalone/7.23.5/babel.min.js"></script>

    <!-- PDF.js -->
    <script src="https://cdn.staticfile.net/pdf.js/3.11.174/pdf.min.js"></script>

    <!-- Mammoth.js -->
    <script src="https://cdn.staticfile.net/mammoth/1.6.0/mammoth.browser.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=Noto+Serif+SC:wght@300;400;700&display=swap');
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans SC", sans-serif; user-select: none; -webkit-user-select: none; }
        .font-serif { font-family: 'Noto Serif SC', serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        html { -webkit-tap-highlight-color: transparent; }
        
        .glass-panel-light { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(20px); border-top: 1px solid rgba(0,0,0,0.05); }
        .glass-panel-dark { background: rgba(28, 28, 30, 0.98); backdrop-filter: blur(20px); border-top: 1px solid rgba(255,255,255,0.1); }
        
        .reading-active-light { background-color: rgba(10, 132, 255, 0.1); color: #000; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .reading-active-dark { background-color: rgba(255, 255, 255, 0.08); color: #fff; border-radius: 4px; }

        .sentence-active { text-decoration: underline; text-decoration-style: dotted; text-decoration-thickness: 1px; text-underline-offset: 5px; }
        .light .sentence-active { text-decoration-color: rgba(10, 132, 255, 0.6); }
        .dark .sentence-active { text-decoration-color: rgba(100, 210, 255, 0.6); }
        
        .read-past { opacity: 0.4; filter: grayscale(0.8); transition: opacity 0.5s ease; }
        
        /* ä¸»é¢˜æ ·å¼ */
        .theme-paper { background-color: #f6f3e8 !important; color: #3b3830 !important; background-image: url("data:image/svg+xml,%3Csvg width='200' height='200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.05'/%3E%3C/svg%3E"); }
        .theme-sepia { background-color: #f6ecd5 !important; color: #5b4636 !important; }
        
        @keyframes fadeInOut { 0% { opacity: 0; transform: translate(-50%, 20px); } 10% { opacity: 1; transform: translate(-50%, 0); } 90% { opacity: 1; transform: translate(-50%, 0); } 100% { opacity: 0; transform: translate(-50%, -20px); } }
        .toast-message { animation: fadeInOut 3s forwards; }

        .custom-range { -webkit-appearance: none; height: 4px; border-radius: 2px; width: 100%; }
        .custom-range::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: #0a84ff; box-shadow: 0 1px 3px rgba(0,0,0,0.3); margin-top: -7px; }
        .custom-range::-webkit-slider-runnable-track { width: 100%; height: 4px; border-radius: 2px; }
        
        /* æ ¸å¿ƒæ’ç‰ˆï¼šå¼ºåˆ¶ä¸¤ç«¯å¯¹é½ï¼Œå¡«æ»¡å®¹å™¨ */
        .text-justify-custom { 
            text-align: justify; 
            text-justify: inter-ideograph; 
            text-indent: 0 !important; 
            word-break: break-all; 
            margin: 0; padding: 0;
        }
        .justify-last-line { 
            text-align-last: justify; 
            -moz-text-align-last: justify; 
            -webkit-text-align-last: justify; 
        }
    </style>
</head>
<body class="antialiased overflow-hidden fixed inset-0 bg-white dark:bg-black text-black dark:text-gray-200 transition-colors duration-300">
    <div id="root" class="h-full w-full"></div>
    
    <script>
        window.onerror = function(msg, url, line, col, error) { console.error("Global Error:", msg, error); };
        
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').catch((error) => { console.log('SW æ³¨å†Œå¤±è´¥:', error); });
            });
        }
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        const DB_KEY = 'litereader_books_v12'; 
        const SETTINGS_KEY = 'litereader_settings_v31'; // å‡çº§é…ç½®ç‰ˆæœ¬
        const MAX_FILE_SIZE_MB = 50;
        
        if (window.pdfjsLib) {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.staticfile.net/pdf.js/3.11.174/pdf.worker.min.js';
        }

        const getBookCoverStyle = (title) => {
            const styles = ['bg-gradient-to-br from-indigo-400 to-cyan-400', 'bg-gradient-to-br from-teal-500 to-emerald-500', 'bg-gradient-to-br from-blue-500 to-indigo-600', 'bg-gradient-to-br from-sky-400 to-blue-500', 'bg-gradient-to-br from-violet-500 to-purple-600', 'bg-gradient-to-br from-slate-500 to-gray-700', 'bg-gradient-to-br from-cyan-500 to-blue-400', 'bg-gradient-to-br from-fuchsia-500 to-purple-600'];
            let hash = 0;
            if (title) for (let i = 0; i < title.length; i++) hash = title.charCodeAt(i) + ((hash << 5) - hash);
            return styles[Math.abs(hash) % styles.length];
        };

        const Icon = ({ name, size = 24, className = "", strokeWidth = 2, fill="none" }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (window.lucide && ref.current) {
                    ref.current.innerHTML = `<i data-lucide="${name}"></i>`;
                    window.lucide.createIcons({ root: ref.current, attrs: { width: size, height: size, class: "lucide-icon", stroke: "currentColor", "stroke-width": strokeWidth, fill: fill } });
                }
            }, [name, size, strokeWidth, fill]);
            return <span ref={ref} className={`inline-flex items-center justify-center ${className}`} />;
        };

        const decodeTextBuffer = (buffer) => {
            try { return new TextDecoder('utf-8', { fatal: true }).decode(buffer); }
            catch (e) { try { return new TextDecoder('gbk', { fatal: false }).decode(buffer); } catch (e2) { return "è§£ç å¤±è´¥"; } }
        };

        const parseFile = async (file) => {
            const fileType = file.name.split('.').pop().toLowerCase();
            const buffer = await file.arrayBuffer();
            if (fileType === 'txt') {
                const text = decodeTextBuffer(buffer);
                return { content: text.split(/\r?\n/).filter(line => line.trim().length > 0), type: 'txt' };
            } else if (fileType === 'pdf') {
                if(!window.pdfjsLib) throw new Error("PDFç»„ä»¶åŠ è½½å¤±è´¥");
                const pdf = await pdfjsLib.getDocument(buffer).promise;
                let fullText = [];
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    fullText.push(textContent.items.map(item => item.str).join(' '));
                }
                return { content: fullText, type: 'pdf' };
            } else if (fileType === 'docx') {
                if(!window.mammoth) throw new Error("Docxç»„ä»¶åŠ è½½å¤±è´¥");
                try {
                    const result = await mammoth.extractRawText({arrayBuffer: buffer});
                    const text = result.value; 
                    return { 
                        content: text.split(/\r?\n/).filter(line => line.trim().length > 0), 
                        type: 'docx' 
                    };
                } catch (e) {
                    throw new Error("Docxè§£æå¤±è´¥: " + e.message);
                }
            }
            return { content: ["ä¸æ”¯æŒçš„æ ¼å¼"], type: 'other' };
        };

        const detectChapters = (content) => {
            const chapters = [];
            const regex = /(?:^|\s)(?:ç¬¬\s*[0-9é›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒ]+\s*[ç« å›èŠ‚å·é›†éƒ¨ç¯‡]|Chapter\s*\d+|^\d+\s*[\.ã€]\s*)/i;
            content.forEach((line, index) => {
                if (line.trim().length < 50 && regex.test(line.trim())) chapters.push({ title: line.trim(), index: index });
            });
            return chapters;
        };

        const toChineseNum = (num) => {
            const digits = ['é›¶','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','ä¸ƒ','å…«','ä¹'];
            const units = ['','å','ç™¾','åƒ','ä¸‡'];
            let n = parseInt(num);
            if (n === 0) return digits[0];
            let str = '';
            let unitIndex = 0;
            while (n > 0) {
                let d = n % 10;
                if (d > 0) str = digits[d] + units[unitIndex] + str;
                else if (str.length > 0 && str[0] !== digits[0]) str = digits[0] + str;
                n = Math.floor(n / 10);
                unitIndex++;
            }
            return str.replace(/^ä¸€å/, 'å');
        };

        const extractMeta = (filename, content) => {
            const name = filename.replace(/\.[^/.]+$/, "");
            let title = name; let author = "ä½šå";
            const separators = ['-', '_', 'â€”â€”', ' by '];
            for (let sep of separators) {
                if (name.includes(sep)) {
                    const parts = name.split(sep);
                    if (parts.length >= 2) { title = parts[0].trim(); author = parts[parts.length - 1].trim(); break; }
                }
            }
            const totalChars = content.reduce((acc, curr) => acc + curr.length, 0);
            return { title, author, totalChars };
        };

        // --- App ---
        const App = () => {
            const [view, setView] = useState('shelf');
            const [books, setBooks] = useState(() => {
                try { return JSON.parse(localStorage.getItem(DB_KEY)) || []; } catch { return []; }
            });
            const [currentBookId, setCurrentBookId] = useState(null);
            const [readerAutoPlay, setReaderAutoPlay] = useState(false); 
            
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            const [settings, setSettings] = useState(() => {
                try { 
                    const saved = JSON.parse(localStorage.getItem(SETTINGS_KEY));
                    return {
                        theme: 'system', fontSize: 18, speechRate: 1.0, 
                        linesPerPage: 18, // æ”¹ä¸ºè¡Œæ•°æ§åˆ¶ï¼Œé»˜è®¤18è¡Œ
                        lineHeight: 1.8, pageMargin: 30, 
                        indent: false, 
                        fontFamily: 'sans', voiceURI: null, brightness: 100, ...saved
                    }; 
                } catch { 
                    return { theme: 'system', fontSize: 18, speechRate: 1.0, linesPerPage: 18, lineHeight: 1.8, pageMargin: 30, indent: false, fontFamily: 'sans', brightness: 100 }; 
                }
            });

            const isDarkMode = settings.theme === 'dark' || (settings.theme === 'system' && systemPrefersDark);
            const isPaperMode = settings.theme === 'paper';
            const isSepiaMode = settings.theme === 'sepia';

            useEffect(() => {
                const root = document.documentElement;
                root.classList.remove('dark', 'light', 'paper', 'theme-paper', 'theme-sepia');
                if (isPaperMode) root.classList.add('theme-paper');
                else if (isSepiaMode) root.classList.add('theme-sepia');
                else if (isDarkMode) root.classList.add('dark');
                else root.classList.add('light');
                
                if (isPaperMode) { document.body.style.backgroundColor = '#f6f3e8'; document.body.style.color = '#3b3830'; }
                else if (isSepiaMode) { document.body.style.backgroundColor = '#f6ecd5'; document.body.style.color = '#5b4636'; }
                else if (isDarkMode) { document.body.style.backgroundColor = '#000000'; document.body.style.color = '#e5e5e7'; }
                else { document.body.style.backgroundColor = '#ffffff'; document.body.style.color = '#1f2937'; }
            }, [settings.theme, systemPrefersDark, isDarkMode, isPaperMode, isSepiaMode]);

            useEffect(() => localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings)), [settings]);
            useEffect(() => localStorage.setItem(DB_KEY, JSON.stringify(books)), [books]);

            useEffect(() => {
                const handlePopState = (event) => {
                    if (view === 'reader' || view === 'me') setView('shelf');
                };
                window.addEventListener('popstate', handlePopState);
                return () => window.removeEventListener('popstate', handlePopState);
            }, [view]);

            const changeView = (newView) => {
                if (newView === 'reader' || newView === 'me') {
                    window.history.pushState({ view: newView }, '');
                }
                setView(newView);
            };

            const activeBook = useMemo(() => books.find(b => b.id === currentBookId), [books, currentBookId]);

            const handleImport = async (e) => {
                const files = Array.from(e.target.files);
                if (!files.length) return;
                for (let file of files) {
                    try {
                        const parsed = await parseFile(file);
                        const meta = extractMeta(file.name, parsed.content);
                        const newBook = {
                            id: Date.now() + Math.random().toString(),
                            title: meta.title, author: meta.author, totalChars: meta.totalChars,
                            content: parsed.content, chapters: detectChapters(parsed.content), type: parsed.type,
                            progressIndex: 0, lastRead: 0, totalTime: 0, readingLogs: {}
                        };
                        setBooks(prev => {
                            const exists = prev.some(b => b.title === newBook.title && b.content.length === newBook.content.length);
                            if (exists) return prev;
                            return [newBook, ...prev];
                        });
                    } catch (err) { console.error(err); }
                }
            };

            const deleteBooks = (ids) => setBooks(prev => prev.filter(b => !ids.has(b.id)));

            const handleUpdateProgress = (id, updates) => {
                setBooks(prev => prev.map(b => {
                    if (b.id !== id) return b;
                    const newBook = { ...b, ...updates };
                    if (updates.addTime) {
                        const todayDate = new Date().toISOString().slice(0, 10);
                        const currentLogs = b.readingLogs || {};
                        newBook.totalTime = (b.totalTime || 0) + updates.addTime;
                        newBook.readingLogs = { ...currentLogs, [todayDate]: (currentLogs[todayDate] || 0) + updates.addTime };
                        delete newBook.addTime;
                    }
                    return newBook;
                }));
            };

            const renderContent = () => {
                if (view === 'reader') {
                    if(!activeBook) { setTimeout(() => changeView('shelf'), 0); return null; }
                    return <Reader 
                        book={activeBook} settings={settings} setSettings={setSettings}
                        onBack={() => window.history.back()} 
                        isDarkMode={isDarkMode} isPaperMode={isPaperMode} isSepiaMode={settings.theme === 'sepia'}
                        updateProgress={handleUpdateProgress}
                        autoPlayOnMount={readerAutoPlay} 
                    />;
                }
                if (view === 'me') {
                    return <MePage settings={settings} setSettings={setSettings} books={books} />;
                }
                return <Bookshelf 
                    books={books} onImport={handleImport} 
                    onOpen={(id, autoPlay = false) => { 
                        handleUpdateProgress(id, { lastRead: Date.now() });
                        setCurrentBookId(id); 
                        setReaderAutoPlay(autoPlay); 
                        changeView('reader'); 
                    }}
                    onDelete={deleteBooks} settings={settings} setSettings={setSettings} isDarkMode={isDarkMode}
                />;
            };

            return (
                <div className={`h-full w-full flex flex-col ${isPaperMode ? 'theme-paper' : ''}`}>
                    <div className="flex-1 relative overflow-hidden">{renderContent()}</div>
                    {view !== 'reader' && (
                        <div className={`h-16 border-t flex justify-around items-center text-[10px] z-40 fixed bottom-0 w-full safe-bottom ${isDarkMode ? 'bg-[#121212] border-white/10' : 'bg-white border-gray-200'}`}>
                            <button className={`flex flex-col items-center gap-1 w-16 btn-press transition-colors ${view === 'shelf' ? 'text-brand' : 'text-gray-400 dark:text-gray-500'}`} onClick={() => changeView('shelf')}>
                                <Icon name="library" size={24} fill={view === 'shelf' ? "currentColor" : "none"} />
                                <span className="font-medium text-[11px]">ä¹¦æ¶</span>
                            </button>
                            <button className={`flex flex-col items-center gap-1 w-16 btn-press transition-colors ${view === 'me' ? 'text-brand' : 'text-gray-400 dark:text-gray-500'}`} onClick={() => changeView('me')}>
                                <Icon name="user" size={24} fill={view === 'me' ? "currentColor" : "none"} />
                                <span className="font-medium text-[11px]">æˆ‘</span>
                            </button>
                        </div>
                    )}
                </div>
            );
        };

        // --- Me Page ---
        const MePage = ({ settings, setSettings, books }) => {
            const [showNotesList, setShowNotesList] = useState(false);
            const stats = useMemo(() => {
                let totalDuration = 0; let finishedCount = 0; let readingCount = 0; let monthDuration = 0; let totalNotes = 0;
                const currentMonthPrefix = new Date().toISOString().slice(0, 7); 
                const booksReadThisMonth = new Set();
                const allNotes = [];
                books.forEach(b => {
                    totalDuration += (b.totalTime || 0);
                    const progress = b.content.length > 0 ? (b.progressIndex / b.content.length) : 0;
                    if (progress > 0.99) finishedCount++; else if (progress > 0) readingCount++;
                    if (b.readingLogs) { Object.entries(b.readingLogs).forEach(([date, time]) => { if (date.startsWith(currentMonthPrefix)) { monthDuration += time; booksReadThisMonth.add(b.id); } }); }
                    if (b.notes && b.notes.length > 0) { totalNotes += b.notes.length; b.notes.forEach(note => allNotes.push({...note, bookTitle: b.title})); }
                });
                allNotes.sort((a, b) => b.date - a.date);
                return { totalHours: Math.floor(totalDuration / 60), totalMins: totalDuration % 60, finished: finishedCount, reading: readingCount, monthBooks: booksReadThisMonth.size, monthHours: (monthDuration / 60).toFixed(1), totalNotes, allNotes };
            }, [books]);
            if (showNotesList) { return <div className="flex flex-col h-full bg-white dark:bg-black safe-top"><div className="h-16 flex items-center px-4 border-b border-gray-100 dark:border-white/10"><button onClick={() => setShowNotesList(false)} className="p-2 -ml-2 text-gray-500"><Icon name="arrow-left" size={24}/></button><h2 className="text-lg font-bold ml-2">æˆ‘çš„ç¬”è®° ({stats.totalNotes})</h2></div><div className="flex-1 overflow-y-auto p-4 pb-20">{stats.allNotes.length === 0 ? <div className="flex flex-col items-center justify-center h-64 text-gray-400"><Icon name="file-text" size={48} className="mb-4 opacity-30"/><p>æš‚æ— ç¬”è®°</p></div> : stats.allNotes.map((note, i) => <div key={i} className="mb-4 p-4 rounded-xl bg-gray-50 dark:bg-[#1c1c1e] border border-gray-100 dark:border-white/5"><div className="text-sm text-gray-800 dark:text-gray-200 mb-2 leading-relaxed">{note.content}</div><div className="flex justify-between items-center text-[10px] text-gray-400"><span>ã€Š{note.bookTitle}ã€‹</span><span>{new Date(note.date).toLocaleDateString()}</span></div></div>)}</div></div>; }
            return (
                <div className="p-6 pt-12 safe-top pb-24 overflow-y-auto h-full">
                    <h1 className="text-3xl font-bold mb-6">ä¸ªäººä¸­å¿ƒ</h1>
                    <div className="bg-brand text-white rounded-2xl p-6 mb-6 shadow-lg shadow-brand/30"><div className="flex items-center gap-4 mb-6"><div className="w-14 h-14 rounded-full bg-white/20 flex items-center justify-center text-2xl border border-white/30">ğŸ¤ </div><div><div className="font-bold text-lg">æœ¬åœ°ä¹¦å‹</div><div className="text-xs text-white/80 opacity-80">åšæŒé˜…è¯»ï¼Œä¿æŒçƒ­çˆ±</div></div></div><div className="flex justify-between text-center"><div><div className="text-3xl font-bold">{stats.totalHours}<span className="text-sm font-normal opacity-80">h</span> {stats.totalMins}<span className="text-sm font-normal opacity-80">m</span></div><div className="text-xs opacity-60 mt-1">æ€»é˜…è¯»æ—¶é•¿</div></div><div className="w-px bg-white/20"></div><div><div className="text-3xl font-bold">{books.length}</div><div className="text-xs opacity-60 mt-1">è—ä¹¦æ•°é‡</div></div></div></div>
                    <h2 className="text-sm font-bold text-gray-500 mb-3 px-1">é˜…è¯»æ•°æ®</h2>
                    <div className="grid grid-cols-2 gap-4 mb-6"><div className="bg-gray-100 dark:bg-[#1c1c1e] p-4 rounded-xl"><div className="text-2xl font-bold text-brand">{stats.monthBooks} <span className="text-xs text-gray-500 font-normal">æœ¬</span></div><div className="text-xs text-gray-500 mt-1">æœ¬æœˆé˜…è¯»</div></div><div className="bg-gray-100 dark:bg-[#1c1c1e] p-4 rounded-xl"><div className="text-2xl font-bold text-brand">{stats.monthHours} <span className="text-xs text-gray-500 font-normal">å°æ—¶</span></div><div className="text-xs text-gray-500 mt-1">é˜…è¯»æ—¶é—´</div></div></div>
                    <h2 className="text-sm font-bold text-gray-500 mb-3 px-1">æ›´å¤šåŠŸèƒ½</h2>
                    <div className="space-y-3"><button onClick={() => setShowNotesList(true)} className="w-full p-4 bg-gray-100 dark:bg-[#1c1c1e] rounded-xl flex items-center justify-between btn-press"><div className="flex items-center gap-3"><div className="w-8 h-8 rounded-full bg-brand/10 text-brand flex items-center justify-center"><Icon name="file-text" size={16}/></div><span className="text-sm font-bold">æˆ‘çš„ç¬”è®°</span></div><Icon name="chevron-right" size={16} className="text-gray-400"/></button><button className="w-full p-4 bg-gray-100 dark:bg-[#1c1c1e] rounded-xl text-left text-red-500 btn-press text-sm font-medium" onClick={() => { if(confirm('æ¸…ç©ºæ‰€æœ‰æ•°æ®?')) { localStorage.clear(); window.location.reload(); } }}>æ¸…ç©ºæ‰€æœ‰æ•°æ®</button></div>
                </div>
            );
        };

        // --- Bookshelf ---
        const Bookshelf = ({ books, onImport, onOpen, onDelete, settings, setSettings, isDarkMode }) => {
            const [isSelectionMode, setIsSelectionMode] = useState(false);
            const [selectedIds, setSelectedIds] = useState(new Set());
            const [activeTab, setActiveTab] = useState('default'); 
            const [categoryType, setCategoryType] = useState('progress'); 
            const [searchTerm, setSearchTerm] = useState('');

            const sortedBooks = useMemo(() => {
                let list = books.filter(b => {
                    const matchTitle = b.title.toLowerCase().includes(searchTerm.toLowerCase());
                    const matchAuthor = b.author && b.author.toLowerCase().includes(searchTerm.toLowerCase());
                    return matchTitle || matchAuthor;
                });
                
                if (activeTab === 'default') {
                    return list.sort((a, b) => (a.lastRead === b.lastRead ? (b.id > a.id ? 1 : -1) : b.lastRead - a.lastRead));
                } else {
                    if (categoryType === 'progress') {
                        return list.sort((a, b) => {
                            const pa = a.content.length ? (a.progressIndex / a.content.length) : 0;
                            const pb = b.content.length ? (b.progressIndex / b.content.length) : 0;
                            return pb - pa;
                        });
                    }
                    if (categoryType === 'author') {
                        return list.sort((a, b) => (a.author || "").localeCompare(b.author || ""));
                    }
                    if (categoryType === 'import') {
                        return list.sort((a, b) => b.id > a.id ? -1 : 1);
                    }
                }
                return list;
            }, [books, searchTerm, activeTab, categoryType]);

            const recentBook = useMemo(() => {
                if (activeTab !== 'default') return null; 
                const read = books.filter(b => b.lastRead > 0);
                if (read.length === 0) return null;
                return read.sort((a, b) => b.lastRead - a.lastRead)[0];
            }, [books, activeTab]);
            
            const listBooks = sortedBooks;
            const toggleSelect = (id) => { const newSet = new Set(selectedIds); if (newSet.has(id)) newSet.delete(id); else newSet.add(id); setSelectedIds(newSet); };
            const handleDelete = () => { if (confirm(`ç¡®å®šåˆ é™¤é€‰ä¸­çš„ ${selectedIds.size} æœ¬ä¹¦?`)) { onDelete(selectedIds); setIsSelectionMode(false); setSelectedIds(new Set()); } };

            return (
                <div className="flex flex-col h-full bg-[#fcfcfc] dark:bg-black safe-top pb-16 text-black dark:text-white" onClick={() => {}}>
                    {/* Header - å›å½’ LiteReader è½»é˜… */}
                    <div className="pt-[calc(env(safe-area-inset-top)+1rem)] px-4 pb-2 bg-[#fcfcfc] dark:bg-black z-10">
                        <div className="h-8 flex items-center justify-between mb-4">
                            <span className="text-2xl font-bold tracking-wider">LiteReader è½»é˜…</span>
                        </div>
                        <div className="h-10 bg-gray-100 dark:bg-[#1c1c1e] rounded-xl flex items-center px-3 gap-2 transition-all focus-within:ring-1 focus-within:ring-brand/50">
                            <Icon name="search" size={18} className="text-gray-400" />
                            <input type="text" placeholder="æœç´¢ä¹¦åæˆ–ä½œè€…..." className="bg-transparent border-none outline-none text-sm w-full text-gray-700 dark:text-gray-200 placeholder-gray-400" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
                            {searchTerm && <button onClick={() => setSearchTerm('')} className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200"><Icon name="x-circle" size={16} fill="currentColor" className="opacity-50"/></button>}
                        </div>
                    </div>
                    
                    <div className="px-4 flex items-center gap-6 mb-2 border-b border-gray-100 dark:border-white/5">
                        <button onClick={() => setActiveTab('default')} className={`pb-2 text-sm font-bold transition-all relative ${activeTab === 'default' ? 'text-brand' : 'text-gray-400'}`}>é»˜è®¤ {activeTab === 'default' && <div className="absolute bottom-0 left-1/2 -translate-x-1/2 w-4 h-0.5 bg-brand rounded-full"></div>}</button>
                        <button onClick={() => setActiveTab('category')} className={`pb-2 text-sm font-bold transition-all relative ${activeTab === 'category' ? 'text-brand' : 'text-gray-400'}`}>åˆ†ç±» {activeTab === 'category' && <div className="absolute bottom-0 left-1/2 -translate-x-1/2 w-4 h-0.5 bg-brand rounded-full"></div>}</button>
                        <div className="flex-1 flex justify-end pb-2">{isSelectionMode ? <button onClick={() => setIsSelectionMode(false)} className="text-xs font-medium text-gray-500 bg-gray-100 dark:bg-white/10 px-3 py-1 rounded-full">å–æ¶ˆ</button> : <div className="flex gap-2"><label className="flex items-center gap-1 text-xs font-medium cursor-pointer btn-press text-brand bg-brand/10 px-3 py-1 rounded-full"><Icon name="plus" size={14} /> å¯¼å…¥<input type="file" multiple className="hidden" onChange={onImport} accept=".txt,.pdf,.docx" /></label><button onClick={() => setIsSelectionMode(true)} className="flex items-center gap-1 text-xs font-medium btn-press text-gray-600 dark:text-gray-300 bg-gray-100 dark:bg-white/10 px-3 py-1 rounded-full"><Icon name="check" size={14} /> é€‰æ‹©</button></div>}</div>
                    </div>
                    {activeTab === 'category' && (<div className="px-4 flex gap-2 mb-3 overflow-x-auto no-scrollbar">{['progress', 'author', 'import'].map(type => (<button key={type} onClick={() => setCategoryType(type)} className={`px-3 py-1 text-[10px] rounded-full transition-colors ${categoryType === type ? 'bg-brand text-white' : 'bg-gray-100 dark:bg-white/10 text-gray-500'}`}>{type === 'progress' ? 'æŒ‰è¿›åº¦' : type === 'author' ? 'æŒ‰ä½œè€…' : 'æŒ‰å¯¼å…¥'}</button>))}</div>)}
                    
                    {isSelectionMode && <div className="px-4 mb-3 flex justify-between items-center bg-red-50 dark:bg-red-900/20 p-3 rounded-xl"><span className="text-sm text-red-500">å·²é€‰ {selectedIds.size} æœ¬</span><button onClick={handleDelete} className="text-sm font-bold text-white bg-red-500 px-4 py-1.5 rounded-full shadow-md shadow-red-500/30">åˆ é™¤</button></div>}
                    <div className="flex-1 overflow-y-auto px-4 pb-4">
                        <div className="grid grid-cols-3 gap-x-4 gap-y-6">
                            {recentBook && !isSelectionMode && !searchTerm && (
                                <div onClick={() => onOpen(recentBook.id)} className="col-span-3 mb-2 relative group cursor-pointer btn-press">
                                    <div className="absolute inset-0 bg-gradient-to-r from-blue-600 to-purple-600 rounded-2xl blur opacity-20"></div>
                                    <div className="relative bg-white dark:bg-[#1e1e1e] border border-gray-100 dark:border-white/5 p-5 rounded-2xl flex gap-4 items-center shadow-sm">
                                        <div className={`w-16 h-20 rounded-lg shadow-lg flex items-center justify-center ${getBookCoverStyle(recentBook.title)}`}><span className="text-xs font-bold text-white/90">{recentBook.type}</span></div>
                                        <div className="flex-1"><div className="text-xs text-brand mb-1">æœ€è¿‘é˜…è¯»</div><h3 className="font-bold text-lg leading-tight mb-2 line-clamp-1">{recentBook.title}</h3><div className="text-xs text-gray-400 mt-1">{(() => { const p = Math.round((recentBook.progressIndex / Math.max(1, recentBook.content.length)) * 100); return (recentBook.lastRead > 0 && p === 0) ? 1 : p; })()}%</div></div>
                                    </div>
                                </div>
                            )}
                            {listBooks.map(book => {
                                const progress = Math.round((book.progressIndex / Math.max(1, book.content.length)) * 100);
                                const displayProgress = (book.lastRead > 0 && progress === 0) ? 1 : progress;
                                return (
                                <div key={book.id} onClick={() => isSelectionMode ? toggleSelect(book.id) : onOpen(book.id)} className={`flex flex-col gap-2 cursor-pointer btn-press relative`}>
                                    <div className={`w-full aspect-[3/4] rounded-[4px] shadow-md relative overflow-hidden ${getBookCoverStyle(book.title)}`}>
                                        <div className="absolute inset-y-0 left-0 w-1 bg-gradient-to-r from-black/20 to-transparent"></div>
                                        <div className="absolute bottom-1 left-1 text-white/80"><Icon name="book" size={12} fill="currentColor"/></div>
                                        <div className="p-2 h-full flex items-center justify-center text-center"><span className="text-xs font-bold text-white/90 line-clamp-3 leading-tight drop-shadow-sm">{book.title}</span></div>
                                        {isSelectionMode && <div className={`absolute inset-0 bg-black/40 flex items-center justify-center ${selectedIds.has(book.id) ? 'opacity-100' : 'opacity-0'}`}><div className="bg-brand rounded-full p-1 text-white"><Icon name="check" size={16} strokeWidth={4} /></div></div>}
                                        {isSelectionMode && !selectedIds.has(book.id) && <div className="absolute top-2 right-2 w-5 h-5 rounded-full border-2 border-white/80"></div>}
                                    </div>
                                    <div className="w-full"><div className="flex items-center gap-1 mb-1">{isSelectionMode ? null : <Icon name="check-circle" size={10} className="text-gray-400 fill-gray-400 flex-shrink-0" />}<div className="text-[11px] text-gray-800 dark:text-gray-300 truncate font-medium">{book.title}</div></div><div className="flex items-center justify-between"><span className="text-[9px] text-gray-500 truncate max-w-[60%]">{book.author || 'æœªåˆ†ç±»'}</span><span className={`text-[9px] font-mono ${displayProgress > 0 ? 'text-brand font-bold' : 'text-gray-400'}`}>{displayProgress}%</span></div></div>
                                </div>
                            )})}
                            <label className="flex flex-col gap-2 cursor-pointer btn-press"><div className="w-full aspect-[3/4] bg-gray-100 dark:bg-[#1c1c1e] rounded-[4px] flex items-center justify-center text-gray-400 dark:text-gray-600 border-2 border-dashed border-gray-300 dark:border-white/10"><Icon name="plus" size={32} /></div><div className="text-[11px] text-center text-gray-400">å¯¼å…¥ä¹¦ç±</div><input type="file" multiple className="hidden" onChange={onImport} accept=".txt,.pdf,.docx" /></label>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Reader ---
        const Reader = ({ book, settings, setSettings, onBack, updateProgress, isDarkMode, isPaperMode, isSepiaMode, autoPlayOnMount }) => {
            const [showMenu, setShowMenu] = useState(false);
            const [showNoteInput, setShowNoteInput] = useState(false); 
            const [noteText, setNoteText] = useState('');
            const [activeTab, setActiveTab] = useState('progress'); 
            const [timerMinutes, setTimerMinutes] = useState(null); 
            const [countdown, setCountdown] = useState(null); 
            const [toastMsg, setToastMsg] = useState(null);
            const [availableVoices, setAvailableVoices] = useState([]); 
            const [readingCharIndex, setReadingCharIndex] = useState(0); 
            const [customTimerInput, setCustomTimerInput] = useState(false); 
            const [customMinutes, setCustomMinutes] = useState('');
            
            const [currentPage, setCurrentPage] = useState(0);
            const [ttsState, setTtsState] = useState('stopped');
            const [startTime] = useState(Date.now());
            
            const synth = window.speechSynthesis;
            const contentRef = useRef(null);
            const ttsRef = useRef(null);
            const ttsStateRef = useRef(ttsState);
            const settingsRef = useRef(settings);
            const heartbeatRef = useRef(null);
            const timerRef = useRef(null); 

            // æ–‡å­—æ ·å¼
            const textStyle = useMemo(() => {
                let color = isDarkMode ? '#e5e5e7' : '#1f2937';
                if (isPaperMode) color = '#3b3830';
                if (isSepiaMode) color = '#5b4636';
                
                return { 
                    fontSize: `${settings.fontSize}px`, 
                    lineHeight: settings.lineHeight, 
                    textIndent: 0, 
                    fontFamily: settings.fontFamily === 'serif' ? '"Noto Serif SC", serif' : '"Noto Sans SC", sans-serif', 
                    color: color 
                };
            }, [settings, isDarkMode, isPaperMode, isSepiaMode]);

            // å®¹å™¨æ ·å¼
            const contentStyle = {
                paddingTop: `max(50px, env(safe-area-inset-top))`,
                paddingBottom: `100px`,
                paddingLeft: `${settings.pageMargin}px`,
                paddingRight: `${settings.pageMargin}px`,
                height: '100vh',
                boxSizing: 'border-box'
            };

            const splitSentences = (text) => {
                const sentences = []; let current = ''; let startIndex = 0;
                for (let i = 0; i < text.length; i++) { const char = text[i]; current += char; if (/[.!?ã€‚ï¼ï¼Ÿ\n]/.test(char) || i === text.length - 1) { sentences.push({ text: current, start: startIndex, end: startIndex + current.length }); startIndex += current.length; current = ''; } }
                return sentences;
            };
            const chapters = useMemo(() => { if (book.chapters && book.chapters.length > 0) return book.chapters; return detectChapters(book.content); }, [book]);
            useEffect(() => { ttsStateRef.current = ttsState; }, [ttsState]);
            useEffect(() => { settingsRef.current = settings; }, [settings]);
            useEffect(() => { if(!synth) return; const load = () => setAvailableVoices(synth.getVoices().filter(v => v.lang.includes('zh') || v.lang.includes('cmn') || v.name.includes('Chinese'))); load(); if (synth.onvoiceschanged !== undefined) synth.onvoiceschanged = load; }, []);
            
            // *** æ ¸å¿ƒï¼šæµå¼åˆ†é¡µå¼•æ“ (è¡Œæ•°ä¼˜å…ˆ) ***
            const pages = useMemo(() => {
                const containerWidth = window.innerWidth - (settings.pageMargin * 2); 
                // è®¡ç®—æ¯è¡Œå­—æ•° (å‘ä¸‹å–æ•´)
                const charsPerLine = Math.floor(containerWidth / settings.fontSize);
                // å•é¡µå®¹é‡ = æ¯è¡Œå­—æ•° * è®¾å®šè¡Œæ•°
                const capacity = charsPerLine * settings.linesPerPage;

                const result = []; let page = []; let curChars = 0;
                const chapterIndices = new Set(book.chapters ? book.chapters.map(c => c.index) : []);
                book.content.forEach((txt, idx) => {
                    const text = txt.replace(/^\s+/, ''); if (text.length === 0) return; 
                    
                    const isChapterStart = chapterIndices.has(idx);
                    if (isChapterStart && page.length > 0) { result.push(page); page = []; curChars = 0; }

                    let remainingText = text;
                    while (remainingText.length > 0) {
                        const spaceLeft = capacity - curChars;
                        
                        if (remainingText.length <= spaceLeft) {
                            // å…¨éƒ¨æ”¾å…¥
                            page.push({ text: remainingText, index: idx, split: false });
                            curChars += remainingText.length;
                            remainingText = "";
                        } else {
                            // æ”¾ä¸ä¸‹ï¼Œåˆ‡åˆ†å¡«æ»¡
                            // ä¸¥æ ¼æŒ‰å­—æ•°åˆ‡åˆ†ï¼Œé…åˆ CSS justify-last-line å®ç°å¯¹é½
                            let cutIdx = spaceLeft;
                            const chunk = remainingText.substring(0, cutIdx);
                            page.push({ text: chunk, index: idx, split: true });
                            
                            result.push(page);
                            page = []; curChars = 0;
                            remainingText = remainingText.substring(cutIdx);
                        }
                        
                        // æ»¡é¡µ
                        if (curChars >= capacity) {
                            result.push(page);
                            page = []; curChars = 0;
                        }
                    }
                });
                if (page.length > 0) result.push(page);
                return result;
            }, [book.content, settings.linesPerPage, settings.pageMargin, settings.fontSize, chapters]);

            const totalPages = Math.max(1, pages.length);
            const currentChapterNum = useMemo(() => { if (pages.length === 0 || !pages[currentPage] || pages[currentPage].length === 0) return ""; const firstParaIdx = pages[currentPage][0].index; let chapterIndex = -1; for (let i = 0; i < (book.chapters||[]).length; i++) { if (book.chapters[i].index <= firstParaIdx) { chapterIndex = i; } else { break; } } if (chapterIndex !== -1) return `ç¬¬${toChineseNum(chapterIndex + 1)}ç« `; return ""; }, [currentPage, pages, book.chapters]);

            useEffect(() => { const p = pages.findIndex(pg => pg.some(item => item.index === (book.progressIndex || 0))); setCurrentPage(p >= 0 ? p : 0); }, []);
            useEffect(() => { if (autoPlayOnMount) setTimeout(() => toggleTTS(), 500); }, []);
            useEffect(() => { const timer = setInterval(() => { updateProgress(book.id, { addTime: 1 }); }, 60000); return () => { clearInterval(timer); if (synth) synth.cancel(); }; }, []);
            useEffect(() => {
                if (timerMinutes) { setCountdown(timerMinutes * 60); if (timerRef.current) clearInterval(timerRef.current); timerRef.current = setInterval(() => { setCountdown(prev => { if (prev <= 1) { clearInterval(timerRef.current); setTimerMinutes(null); if (ttsStateRef.current === 'playing') { synth.cancel(); setTtsState('stopped'); setToastMsg("å®šæ—¶ç»“æŸï¼Œå·²åœæ­¢æœ—è¯»"); setTimeout(()=>setToastMsg(null), 3000); } return 0; } return prev - 1; }); }, 1000); } 
                else { if (timerRef.current) clearInterval(timerRef.current); setCountdown(null); }
                return () => { if (timerRef.current) clearInterval(timerRef.current); };
            }, [timerMinutes]);

            const speak = (idx) => {
                if (!synth) return; if (ttsStateRef.current !== 'playing') return; if (idx >= book.content.length) { setTtsState('stopped'); return; }
                const pIdx = pages.findIndex(pg => pg.some(i => i.index === idx));
                if (pIdx !== -1 && pIdx !== currentPage) { setCurrentPage(pIdx); if(contentRef.current) contentRef.current.scrollTop = 0; }
                updateProgress(book.id, { progressIndex: idx });
                const u = new SpeechSynthesisUtterance(book.content[idx]); window.currentUtterance = u;
                const curSettings = settingsRef.current; u.rate = curSettings.speechRate;
                if (settingsRef.current.voiceURI) { const v = synth.getVoices().find(x => x.voiceURI === settingsRef.current.voiceURI); if(v) u.voice = v; }
                u.onboundary = (event) => { if (event.name === 'sentence' || event.name === 'word') setReadingCharIndex(event.charIndex); };
                u.onend = () => { if (ttsStateRef.current === 'playing') { setReadingCharIndex(0); speak(idx + 1); } };
                u.onerror = (e) => { if (e.error !== 'interrupted' && e.error !== 'canceled') { if(ttsStateRef.current === 'playing') setTimeout(() => speak(idx+1), 100); } };
                ttsRef.current = u; synth.speak(u);
            };
            const toggleTTS = () => { if (ttsState === 'playing') { synth.cancel(); setTtsState('stopped'); } else { synth.cancel(); setTtsState('playing'); ttsStateRef.current = 'playing'; const currentP = pages[currentPage]; const startIdx = (currentP && currentP.length > 0) ? (currentP.find(p => p.index >= (book.progressIndex||0))?.index || currentP[0].index) : (book.progressIndex || 0); speak(startIdx); } };
            const handleParaClick = (idx) => { 
                if (ttsState === 'playing') { updateProgress(book.id, { progressIndex: idx }); synth.cancel(); setTtsState('playing'); ttsStateRef.current = 'playing'; setTimeout(() => speak(idx), 50); }
            };
            const saveNote = () => { if (!noteText.trim()) return; const newNotes = [...(book.notes || []), { id: Date.now(), date: Date.now(), content: noteText, paraIndex: book.progressIndex || 0, pageIndex: currentPage }]; updateProgress(book.id, { notes: newNotes }); setNoteText(''); setShowNoteInput(false); setToastMsg("ç¬”è®°å·²ä¿å­˜"); setTimeout(() => setToastMsg(null), 2000); };
            const toggleFullScreen = () => { if (!document.fullscreenElement) { document.documentElement.requestFullscreen().catch(err => {}); } else { if (document.exitFullscreen) { document.exitFullscreen(); } } };
            
            const handleContentClick = () => { if (showMenu) { setShowMenu(false); } else { setShowMenu(true); setActiveTab('progress'); } };
            const handleTabClick = (tab) => { 
                if (activeTab === tab && showMenu) { setShowMenu(false); } 
                else { setActiveTab(tab); setShowMenu(true); } 
            };
            const ts = useRef(0); const onTouchStart = e => ts.current = e.touches[0].clientX;
            const onTouchEnd = e => { const d = ts.current - e.changedTouches[0].clientX; if (ts.current < 50 && d < -50) { stopTTS(); onBack(); return; } if (Math.abs(d) > 50) { const next = Math.min(Math.max(0, currentPage + (d > 0 ? 1 : -1)), totalPages - 1); setCurrentPage(next); if (contentRef.current) contentRef.current.scrollTop = 0; if (ttsState === 'playing') { synth.cancel(); speak(pages[next][0].index); } else updateProgress(book.id, { progressIndex: pages[next][0].index }); } };
            const stopTTS = () => { if (synth) synth.cancel(); setTtsState('stopped'); if (heartbeatRef.current) clearInterval(heartbeatRef.current); };

            const renderParagraph = (text, isCurrentPara, isSplit) => {
                const splitClass = isSplit ? 'justify-last-line' : '';
                if (!isCurrentPara || ttsState !== 'playing') return <span className={splitClass} style={textStyle}>{text}</span>; 
                const sentences = splitSentences(text); 
                return <span className={splitClass} style={textStyle}>{sentences.map((s, i) => { const isActiveSentence = readingCharIndex >= s.start && readingCharIndex < s.end; return <span key={i} className={isActiveSentence ? 'sentence-active' : ''}>{s.text}</span>; })}</span>; 
            };
            if (!pages[currentPage]) return <div className="h-full flex items-center justify-center">åŠ è½½ä¸­...</div>;
            const jumpToChapter = (idx) => { const pIdx = pages.findIndex(pg => pg.some(i => i.index >= idx)); if (pIdx !== -1) { setCurrentPage(pIdx); updateProgress(book.id, { progressIndex: pages[pIdx][0].index }); if(contentRef.current) contentRef.current.scrollTop = 0; } setShowMenu(false); };

            return (
                <div className={`flex flex-col h-full relative ${isPaperMode ? 'theme-paper' : (isSepiaMode ? 'theme-sepia' : (isDarkMode ? 'bg-[#121212] text-gray-200' : 'bg-white text-gray-800'))}`}>
                    <div className={`fixed top-0 inset-x-0 h-16 z-20 flex items-center px-4 transition-transform duration-300 ${showMenu ? 'translate-y-0' : '-translate-y-full'} ${isDarkMode ? 'bg-black/90' : 'bg-white/95 shadow-sm'}`}>
                        <button onClick={() => {stopTTS(); onBack();}} className="p-2 -ml-2"><Icon name="chevron-left" /></button>
                        <span className="flex-1 text-center text-sm truncate px-4 text-gray-400 font-medium">{currentChapterNum || book.title}</span>
                        <div className="flex items-center gap-2 -mr-2"><button onClick={() => setShowNoteInput(true)} className="p-2"><Icon name="edit-3" /></button><button onClick={toggleFullScreen} className="p-2"><Icon name="maximize" /></button></div>
                    </div>

                    <div ref={contentRef} className="flex-1 overflow-y-auto no-scrollbar animate-slide reader-content" style={contentStyle} onClick={handleContentClick} onTouchStart={onTouchStart} onTouchEnd={onTouchEnd}>{pages[currentPage].map((item, i) => {
                        const isActive = item.index === (book.progressIndex || 0);
                        const isPast = item.index < (book.progressIndex || 0);
                        let activeClass = isDarkMode ? 'reading-active-dark' : 'reading-active-light';
                        if (isPaperMode) activeClass = 'reading-active-paper';
                        if (isSepiaMode) activeClass = 'reading-active-light';
                        
                        const isPlaying = ttsState === 'playing';
                        const finalClass = `mb-4 break-words text-justify-custom ${isPlaying && isActive ? activeClass : ''} ${isPlaying && isPast ? 'read-past' : ''}`;

                        return <p key={i} onClick={(e)=>{ if(isPlaying) { e.stopPropagation(); handleParaClick(item.index); }}} className={finalClass}>{renderParagraph(item.text, isActive, item.isSplit)}</p>
                    })}</div>
                    
                    {!showMenu && <div className="fixed bottom-2 right-4 text-[10px] opacity-40">{currentPage + 1} / {totalPages}</div>}
                    {toastMsg && <div className="fixed top-20 left-1/2 -translate-x-1/2 z-50 bg-black/80 text-white text-xs px-4 py-2 rounded-full shadow-lg">{toastMsg}</div>}
                    {showNoteInput && <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm" onClick={()=>setShowNoteInput(false)}><div className="w-4/5 max-w-sm bg-white dark:bg-[#1e1e1e] p-5 rounded-2xl" onClick={e=>e.stopPropagation()}><h3 className="text-lg font-bold mb-3">æ·»åŠ ç¬”è®°</h3><textarea className="w-full h-32 bg-gray-100 dark:bg-black/30 p-2 rounded-xl mb-4 text-sm" value={noteText} onChange={e=>setNoteText(e.target.value)} placeholder="å†™ç¬”è®°..." /><div className="flex gap-2"><button onClick={()=>setShowNoteInput(false)} className="flex-1 py-2 bg-gray-200 dark:bg-white/10 rounded-xl text-xs">å–æ¶ˆ</button><button onClick={saveNote} className="flex-1 py-2 bg-brand text-white rounded-xl text-xs">ä¿å­˜</button></div></div></div>}
                    {customTimerInput && <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm" onClick={() => setCustomTimerInput(false)}><div className="w-4/5 max-w-sm bg-white dark:bg-[#1e1e1e] p-5 rounded-2xl" onClick={e => e.stopPropagation()}><h3 className="text-lg font-bold mb-3">è‡ªå®šä¹‰æ—¶é—´ (åˆ†é’Ÿ)</h3><input type="number" className="w-full p-3 rounded-xl mb-4 bg-gray-100 dark:bg-black/30 text-center text-lg outline-none" value={customMinutes} onChange={e => setCustomMinutes(e.target.value)} autoFocus /><div className="flex gap-2"><button onClick={() => setCustomTimerInput(false)} className="flex-1 py-2 bg-gray-200 dark:bg-white/10 rounded-xl text-xs">å–æ¶ˆ</button><button onClick={() => { if (customMinutes && !isNaN(customMinutes)) { setTimerMinutes(parseInt(customMinutes)); setCustomTimerInput(false); } }} className="flex-1 py-2 bg-brand text-white rounded-xl text-xs">ç¡®å®š</button></div></div></div>}

                    <div className={`fixed right-6 flex flex-col gap-4 z-30 transition-all duration-300 ${showMenu ? 'bottom-72' : 'bottom-8'}`}>
                        <button onClick={(e) => { e.stopPropagation(); toggleTTS(); }} className={`w-14 h-14 rounded-full shadow-xl flex items-center justify-center btn-active transition-all ${ttsState === 'playing' ? 'bg-brand text-white animate-breathe-glow' : (isDarkMode ? 'bg-gray-800 text-white border border-white/10' : 'bg-white text-gray-800 border border-gray-100')}`}><Icon name={ttsState === 'playing' ? "pause" : "headphones"} size={24} fill={ttsState === 'playing' ? "currentColor" : "none"} /></button>
                    </div>
                    
                    <div className={`fixed bottom-0 inset-x-0 z-30 transition-transform duration-300 ${showMenu ? 'translate-y-0' : 'translate-y-full'} ${isDarkMode ? 'glass-panel-dark' : 'glass-panel-light'}`}>
                        <div className="p-6 pb-20 space-y-6 max-h-[45vh] overflow-y-auto no-scrollbar">
                            {activeTab === 'toc' && <div className="animate-fade-in h-full"><div className="flex justify-between items-center mb-4"><span className="font-bold">ç›®å½•</span><span className="text-xs opacity-60">å…± {chapters.length} ç« </span></div><div className="space-y-1">{chapters.length === 0 ? <div className="text-center py-10 opacity-50 text-xs">æœªè¯†åˆ«åˆ°ç›®å½•</div> : chapters.map((c, i) => <div key={i} onClick={() => jumpToChapter(c.index)} className={`p-3 text-sm rounded-lg cursor-pointer ${isDarkMode ? 'hover:bg-white/5' : 'hover:bg-black/5'}`}>{c.title}</div>)}</div></div>}
                            {activeTab === 'progress' && <div className="space-y-6 animate-fade-in"><div className="flex justify-between items-center text-center"><div><span className="text-xl font-bold block">{Math.max(1, Math.round(((currentPage+1)/totalPages)*100))}%</span><div className="text-[10px] opacity-60 flex items-center gap-1 justify-center">é˜…è¯»è¿›åº¦ {countdown && <span className="text-brand ml-1">{Math.floor(countdown/60)}åˆ†åå…³é—­</span>}</div></div><div className="w-[1px] h-4 bg-gray-500/30"></div><div className="text-right"><div className="text-[10px] opacity-60">æ€»æ—¶é•¿: {Math.max(1, book.totalTime || 0)}åˆ†</div><div className="text-[10px] opacity-60">æœ¬æ¬¡: {Math.max(1, Math.floor((Date.now() - startTime)/60000))}åˆ†</div></div></div><input type="range" min="0" max={totalPages - 1} value={currentPage} onChange={e => { setCurrentPage(parseInt(e.target.value)); if(contentRef.current) contentRef.current.scrollTop = 0; }} className={`custom-range ${isDarkMode ? 'bg-gray-700' : 'bg-gray-200'}`} /></div>}
                            {activeTab === 'layout' && <div className="space-y-4 animate-fade-in"><div className="flex items-center justify-between text-gray-500"><span className="text-[10px] whitespace-nowrap mr-2">å­—ä½“å¤§å°</span><div className={`flex-1 mx-4 flex items-center rounded-full h-8 px-1 relative ${isDarkMode ? 'bg-white/10' : 'bg-gray-100'}`}><div className="absolute h-6 w-6 bg-white rounded-full shadow-sm left-0 transition-all" style={{ left: `calc(${((settings.fontSize - 12) / 20) * 100}% - 12px)` }}></div><input type="range" min="12" max="32" step="2" value={settings.fontSize} onChange={e => setSettings({...settings, fontSize: parseInt(e.target.value)})} className="w-full opacity-0 cursor-pointer z-10" /></div><span className="text-lg">A</span></div><div className="flex items-center justify-between text-gray-500"><span className="text-[10px] whitespace-nowrap mr-2">å•é¡µè¡Œæ•°</span><div className={`flex flex-1 rounded-lg p-1 gap-1 ${isDarkMode ? 'bg-gray-700' : 'bg-gray-200'}`}>{[ { label: 'å°‘(16è¡Œ)', val: 16 }, { label: 'é€‚ä¸­(18è¡Œ)', val: 18 }, { label: 'å¤š(20è¡Œ)', val: 20 } ].map(opt => (<button key={opt.val} onClick={() => setSettings({...settings, linesPerPage: opt.val})} className={`flex-1 py-1 text-[10px] rounded-md transition-all ${settings.linesPerPage === opt.val ? 'bg-white dark:bg-gray-500 shadow text-black dark:text-white font-bold' : 'text-gray-500 dark:text-gray-400'}`}>{opt.label}</button>))}</div></div><div className="flex items-center justify-between text-gray-500"><span className="text-[10px] whitespace-nowrap mr-2">é¡µè¾¹è·</span><div className={`flex flex-1 rounded-lg p-1 gap-1 ${isDarkMode ? 'bg-gray-700' : 'bg-gray-200'}`}><button onClick={() => setSettings({...settings, pageMargin: 20})} className={`flex-1 py-1 text-[10px] rounded-md transition-all ${settings.pageMargin === 20 ? 'bg-white dark:bg-gray-500 shadow text-black dark:text-white font-bold' : 'text-gray-500 dark:text-gray-400'}`}>å°</button><button onClick={() => setSettings({...settings, pageMargin: 40})} className={`flex-1 py-1 text-[10px] rounded-md transition-all ${settings.pageMargin === 40 ? 'bg-white dark:bg-gray-500 shadow text-black dark:text-white font-bold' : 'text-gray-500 dark:text-gray-400'}`}>å¤§</button></div></div><div className="flex items-center justify-between text-gray-500"><span className="text-[10px] whitespace-nowrap mr-2">è¡Œé—´è·</span><div className={`flex flex-1 rounded-lg p-1 gap-1 ${isDarkMode ? 'bg-gray-700' : 'bg-gray-200'}`}><button onClick={() => setSettings({...settings, lineHeight: 1.4})} className={`flex-1 py-1 text-[10px] rounded-md transition-all ${settings.lineHeight === 1.4 ? 'bg-white dark:bg-gray-500 shadow text-black dark:text-white font-bold' : 'text-gray-500 dark:text-gray-400'}`}>ç´§</button><button onClick={() => setSettings({...settings, lineHeight: 1.8})} className={`flex-1 py-1 text-[10px] rounded-md transition-all ${settings.lineHeight === 1.8 ? 'bg-white dark:bg-gray-500 shadow text-black dark:text-white font-bold' : 'text-gray-500 dark:text-gray-400'}`}>é€‚ä¸­</button><button onClick={() => setSettings({...settings, lineHeight: 2.2})} className={`flex-1 py-1 text-[10px] rounded-md transition-all ${settings.lineHeight === 2.2 ? 'bg-white dark:bg-gray-500 shadow text-black dark:text-white font-bold' : 'text-gray-500 dark:text-gray-400'}`}>æ¾</button></div></div></div>}
                            {activeTab === 'voice' && <div className="space-y-4 animate-fade-in"><div className="flex items-center justify-between text-gray-500"><span className="text-[10px] whitespace-nowrap mr-2">éŸ³è‰²</span><div className="flex-1 relative"><select className={`w-full text-xs p-2 rounded-lg outline-none appearance-none ${isDarkMode ? 'bg-gray-700 text-white' : 'bg-gray-200 text-black'}`} value={settings.voiceURI||''} onChange={e => setSettings({...settings, voiceURI: e.target.value})}>{availableVoices.map(v => <option key={v.voiceURI} value={v.voiceURI}>{v.name}</option>)}</select><Icon name="chevron-down" size={14} className="absolute right-2 top-3 pointer-events-none"/></div></div><div className="flex items-center justify-between text-gray-500"><span className="text-[10px] whitespace-nowrap mr-2">è¯­é€Ÿ</span><div className="flex items-center gap-2 flex-1"><input type="range" min="0.5" max="2.0" step="0.1" value={settings.speechRate} onChange={(e) => setSettings({...settings, speechRate: parseFloat(e.target.value)})} className={`flex-1 h-1 rounded-lg appearance-none cursor-pointer ${isDarkMode ? 'bg-gray-600' : 'bg-gray-300'} accent-brand`}/><span className="text-xs font-bold w-8 text-right">{settings.speechRate}x</span></div></div><div className="flex items-center justify-between text-gray-500"><span className="text-[10px] whitespace-nowrap mr-2">å®šæ—¶å…³é—­</span><div className={`flex flex-1 rounded-lg p-1 gap-1 ${isDarkMode ? 'bg-gray-700' : 'bg-gray-200'}`}>{[ { label: 'ä¸å¼€å¯', val: null }, { label: '30åˆ†', val: 30 }, { label: '60åˆ†', val: 60 }, { label: 'è‡ªå®šä¹‰', val: 'custom' } ].map(opt => (<button key={opt.label} onClick={() => { if(opt.val === 'custom') { setCustomTimerInput(true); setCustomMinutes(''); } else { setTimerMinutes(opt.val); } }} className={`flex-1 py-1 text-[10px] rounded-md transition-all ${timerMinutes === opt.val || (opt.val==='custom' && timerMinutes && ![30,60].includes(timerMinutes)) ? 'bg-brand shadow text-white font-bold' : 'text-gray-500 dark:text-gray-400'}`}>{opt.label}</button>))}</div></div></div>}
                            {activeTab === 'theme' && <div className="space-y-4 animate-fade-in"><div className="flex justify-between gap-2">{['light', 'sepia', 'paper', 'dark'].map(t => (<button key={t} onClick={() => setSettings({...settings, theme: t})} className={`flex-1 py-2 rounded-xl border text-xs ${settings.theme === t ? 'border-brand text-brand font-bold bg-brand/10' : 'border-transparent bg-gray-100 dark:bg-white/5'}`}>{t === 'light' ? 'æµ…è‰²' : t === 'sepia' ? 'æŠ¤çœ¼' : t === 'paper' ? 'çº¸è´¨' : 'æ·±è‰²'}</button>))}</div><div className="flex items-center justify-between text-gray-500 animate-fade-in"><span className="text-[10px] whitespace-nowrap mr-2">äº®åº¦</span><div className="flex items-center gap-2 flex-1"><Icon name="sun" size={14} /><input type="range" min="20" max="100" step="5" value={settings.brightness || 100} onChange={(e) => setSettings({...settings, brightness: parseInt(e.target.value)})} className={`flex-1 h-1 rounded-lg appearance-none cursor-pointer ${isDarkMode ? 'bg-gray-600' : 'bg-gray-300'} accent-brand`}/><span className="text-xs font-bold w-8 text-right">{settings.brightness || 100}%</span></div></div></div>}
                        </div>

                        {/* Bottom Nav (Permanent) */}
                        <div className={`absolute bottom-0 w-full flex justify-around items-center h-14 border-t ${isDarkMode ? 'bg-[#121212] border-white/10' : 'bg-white border-gray-200'}`}>
                            <button onClick={() => handleTabClick('toc')} className={`flex flex-col items-center gap-1 btn-press transition-colors ${activeTab === 'toc' ? 'text-brand' : (isDarkMode ? 'text-gray-500' : 'text-gray-400')}`}><Icon name="align-left" size={20} /><span className="text-[10px]">ç›®å½•</span></button>
                            <button onClick={() => handleTabClick('progress')} className={`flex flex-col items-center gap-1 btn-press transition-colors ${activeTab === 'progress' ? 'text-brand' : (isDarkMode ? 'text-gray-500' : 'text-gray-400')}`}><Icon name="sliders-horizontal" size={20} /><span className="text-[10px]">è¿›åº¦</span></button>
                            <button onClick={() => handleTabClick('layout')} className={`flex flex-col items-center gap-1 btn-press transition-colors ${activeTab === 'layout' ? 'text-brand' : (isDarkMode ? 'text-gray-500' : 'text-gray-400')}`}><span className="font-serif text-lg font-bold leading-none">A</span><span className="text-[10px]">ç‰ˆå¼</span></button>
                            <button onClick={() => handleTabClick('voice')} className={`flex flex-col items-center gap-1 btn-press transition-colors ${activeTab === 'voice' ? 'text-brand' : (isDarkMode ? 'text-gray-500' : 'text-gray-400')}`}><Icon name="mic" size={20} /><span className="text-[10px]">æœ—è¯»</span></button>
                            <button onClick={() => handleTabClick('theme')} className={`flex flex-col items-center gap-1 btn-press transition-colors ${activeTab === 'theme' ? 'text-brand' : (isDarkMode ? 'text-gray-500' : 'text-gray-400')}`}><Icon name={isDarkMode ? "moon" : "sun"} size={20} /><span className="text-[10px]">ä¸»é¢˜</span></button>
                        </div>
                    </div>
                    <div className="pointer-events-none fixed inset-0 z-50 bg-black transition-opacity duration-300" style={{ opacity: (100 - (settings.brightness || 100)) / 100 }}></div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>